---
output:
  github_document:
   html_preview: true
params:
  javastics_path: /home/plecharpent/Work/projet_tests_modulostics/JavaSTICS-v141-stics-v9.0
  workspace_path: /home/plecharpent/Work/projet_tests_modulostics/JavaSTICS-v141-stics-v9.0/example
  output_path: /home/plecharpent/tmp/tests_SticsOnR/gen_usms_xml2txt
---


```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
options(tibble.print_min = 5, tibble.print_max = 5)

suppressMessages(library(SticsOnR))
suppressMessages(library(SticsRFiles))
suppressMessages(library(doParallel))
suppressMessages(library(parallel))

```

# SticsOnR: The R package for the [STICS](https://www6.paca.inrae.fr/stics_eng/) model <img src="man/figures/logo.png" alt="logo" width="150" align="right" />

[![Project Status: WIP â€“ Initial development is in progress, but there has not yet been a stable, usable release suitable for the public.](https://www.repostatus.org/badges/latest/wip.svg)](https://www.repostatus.org/#wip)
[![Travis build status](https://travis-ci.org/SticsRPacks/SticsOnR.svg?branch=master)](https://travis-ci.org/SticsRPacks/SticsOnR)
[![Codecov test coverage](https://codecov.io/gh/SticsRPacks/SticsOnR/branch/master/graph/badge.svg)](https://codecov.io/gh/SticsRPacks/SticsOnR?branch=master)

The goal of SticsOnR is to perform simulations of the Stics model, downloadable with its graphical user interface from https://www6.paca.inra.fr/stics_eng/Download.

<!--## Development 

Follow up the development [here](sticsOnR.md).-->



## Installation

The development version from [GitHub](https://github.com/) can be installed with:

``` r
devtools::install_github("SticsRPacks/SticsOnR@*release")
```
Or using the lightweight [remotes](https://github.com/r-lib/remotes#readme) package: 

``` r
# install.packages("remotes")
remotes::install_github("SticsRPacks/SticsOnR@*release")
```
Normaly, all packages dependencies will be installed, either CRAN packages or SticsRPacks 
needed packages. In that case SticsRFiles and CroptimizR will be installed as well.


## Examples

Here are basic examples which show you how to run the model either from a R model interface or a JavaStics (command line) one. More complete examples will be detailed in a specific documentation later.

### Running the JavaStics command line interface

We need for that a JavaStics installed and a JavaStics workspace folder.
For example using the last distribution version for Stics 9.1, (JavaSTICS-1.41-stics-9.1 downloadable [here](https://www6.paca.inrae.fr/stics_eng/Download)).    
It contains an `example` folder with a set of runnable usms.

For running simulations from it, we can use the `run_javastics` function as follows:

```{r echo = FALSE}
javastics_path <- params$javastics_path
workspace_path <- params$workspace_path
output_path <- params$output_path
```


```{r run_javastics, eval = FALSE}

# Specifying the JavaStics folder
javastics_path <- "/path/to/JavaSTICS-1.41-stics-9.1"

# Specifying a workspace as a subfolder of JavaStics 
workspace_path <- "example"

# or an absolute path to an external folder
# workspace_path <- "/path/to/javastics/workspace"

```
```{r}

# Running specific usms from the workspace
run_javastics(javastics_path, workspace_path, usms_list = c("banana","wheat"))

# Running all usms contained in the workspace 
run_javastics(javastics_path, workspace_path)

# Getting returned information about execution 
runs_info <- run_javastics(javastics_path, workspace_path, usms_list = c("banana","wheat"), display = FALSE)

runs_info

```



### Converting JavaStics workspace files
For using the model directly neither using the JavaStics graphical interface nor the run_javastics function interface, we provide a function, `gen_usms_xml2txt`, for converting JavasStics XML files to Stics text files from a JavaStics workspace.

Observation files may also be copied if they have a standard name as an usm name and a `.obs` extension. If not, they must be renamed to do so.

```{r paths_def, eval = FALSE}
# Specifying the JavaStics folder
javastics_path <- "/path/to/JavaSTICS-1.41-stics-9.1"

# Specifying a workspace as a subfolder of JavaStics 
workspace_path <- "example"
# or an absolute path to an extrenal folder
# workspace_path <- "/path/to/javastics/workspace"

# Specifying an output folder path 
output_path <- "/path/to/output/folder"

```

#### Converting files into separated folders (one per usm)
```{r convert_to_separate}
# Generating files for all the usms contained in the workspace
# In the workspace
gen_usms_xml2txt(javastics_path, workspace_path)
# In a specific output folderfolder
gen_usms_xml2txt(javastics_path, workspace_path, target_path = output_path)

# Generating files for a subset of usms
# In the workspace
gen_usms_xml2txt(javastics_path, workspace_path, usms_list = c("banana","wheat"))
# In a specific folder
gen_usms_xml2txt(javastics_path, workspace_path, usms_list = c("banana","wheat"), target_path = output_path)

# Getting returned information about files generation
gen_info <- gen_usms_xml2txt(javastics_path, workspace_path, usms_list = c("banana","wheat"), target_path = output_path)

gen_info
```

#### Converting files into one folder (overwriting case) 
```{r convert_to_one}
# Generating files directly in the workspace or a specific folder (no usm sub-folder) 
# In this case the model files are overwritten at each gen_usms_xml2txt call !
# In the workspace
gen_usms_xml2txt(javastics_path, workspace_path, usms_list = "banana", dir_per_usm_flag = FALSE)

# In a specific folder
gen_usms_xml2txt(javastics_path, workspace_path, usms_list = "banana", 
                 target_path = output_path, dir_per_usm_flag = FALSE)


```


### Running the model

We need for that a JavaStics folder and a directory, or a folder containing usms subdirectories with text input files (converted from xml JavaStics files, see previous section).

The `run_stics` function can be used as follows with one folder or multiple sub-folders.

```{r run_stics}
# Spefifying the Stics executable file path

# for windows/linux
stics_path <- file.path(javastics_path,"bin","stics_modulo")

# for Mac
# stics_path <- file.path(javastics_path,"bin","stics_modulo_mac")

# Specifying a directory containing Stics input files
# For example reusing a generated sub-directory in the previous section
# of the document
# Running on usm
files_dir_path <- file.path(output_path,"banana")
run_stics(stics_path, files_dir_path)

# Specifying a root directory containing usms individual directories
# For example reusing a generated directory in the previous section
# of the document
# Running two usms
run_stics(stics_path, output_path, usm_dir_names = c("banana","wheat"))

# Running all usms sub-directories
run_stics(stics_path, output_path, usm_dir_names = "all")

# Getting returned information about stics runs
runs_info <- run_stics(stics_path, output_path, usm_dir_names = c("banana","wheat"))

runs_info

```


### Advanced simulations paramerization 

A specific function `stics_wrapper` is dedicated to manage simulations with a higher level
of parameterization than the `run_stics` function which only executes runs.

This is a transitional version of the function that will be modified in order to simplify parameter forcing independently from the optimization goal, so apart from the CroptimizR package context. 

This `stics_wrapper` function allows:

* Configuring simulations run behaviour ( through an options list )
* Parameters forcing for usms (common or specific values)
* Returning specific outputs daily data for each usm with possible dates and variables
filtering
* Parallelizing simulations runs, and execution time display

As the `run_stics` function, the `stics_wrapper` operates on directories 
containing text stics input files.

In the next uses case, the directory in which usms sub-directories with text input files 
were generated will be used.


#### Defining simulations options

The mandatory simulation options are fixed using the `stics_wrapper_options`: the model executable path and the directory path containing usms sub-directories with text input files.

```{r}
stics_path <- file.path(javastics_path, "bin","stics_modulo")
sim_options <- stics_wrapper_options(stics_path = stics_path, data_dir = output_path)
```
Optional fields in the `sim_options` list will be set later in this document, when paralellized executions will be activated. 

The content of the options list with default values, can be displayed using the `stics_wrapper_options` function without any argument as follows:
```{r}
stics_wrapper_options()
```


#### Simple simulations cases


* Without filtering usms or outputs

```{r}

results <- stics_wrapper(model_options = sim_options)

```


* Filtering on usms list

```{r}

usms_list <- c("wheat", "pea", "maize")

results <- stics_wrapper(model_options = sim_options, sit_var_dates_mask = usms_list)

```


* Filtering outputs on usms variables and dates using observations data

The argument `sit_var_dates_mask` must contain a named list (with usms names) containing
data.frames organized as observations data or corresponding to observations data.

```{r}
obs_filenames <- paste0(usms_list,".obs")
obs_list <- get_obs(dirpath = workspace_path, obs_filenames = obs_filenames)

# Observations table for wheat
obs_list$wheat

results <- stics_wrapper(model_options = sim_options, sit_var_dates_mask = obs_list)

```
Some warnings may occur, indicating that observed variables and/or observations dates are missing in simulated data. Simulation period and output variables list may be fixed before restarting simulations.

But, for variables names, perhaps they can be badly written and do not correspond exactly the model variables names. 


#### Simulations with forcing parameters

In this case, we can define variables containing information used for parameters forcing management.
They are transmitted to `stics_wrapper` through 2 arguments, one containing a named vector of parameters values `param_values` and the other storing corresponding usms groups to which each parameter value of `param_values` will be applied before running the model.

* Applying a single parameter values vector for all the usms 
```{r}

# No group list information given
# Paratemers vector with unique values
param_values <- c(0.002,50)
names(param_values) <- c("dlaimax", "durvieF")

results <- stics_wrapper(model_options = sim_options, sit_var_dates_mask = usms_list, param_values = param_values)

```

* Using usms specific parameters values vectors 
```{r}
# Defining usms groups using same parameters values
# (may be used in parameter optimization)
# Parameters vector, with parameters values per usms groups
param_values <- c(0.001, 0.002, 50, 51)
names(param_values) <- c("dlaimax", "dlaimax", "durvieF", "durvieF")

# Groups list
# parameters_data <- data.frame(usm=c("wheat", "pea", "maize"), dlaimax=c(0.002,0.002, 0.001), durvieF=c(50, 51, 51), stringsAsFactors = F)
groups_list <- list(dlaimax=list(sit_list=list(c("maize"),c("wheat", "pea"))),
                   durvieF=list(sit_list=list(c("wheat"), c("maize", "pea"))))


results <- stics_wrapper(model_options = sim_options, sit_var_dates_mask = usms_list, param_values = param_values, prior_information = groups_list)

```

For the moment, usms names must be restricted to usms names existing in groups_list. So usms names list must be provided as `sit_var_dates_mask` argument value (in this case ```c("wheat", "pea", "maize")```)


#### Simulations using parallel executions

* Getting standard simulations execution time

```{r}
sim_options <- stics_wrapper_options(stics_path = stics_path, data_dir = output_path,
                                     time_display = TRUE)

results <- stics_wrapper(model_options = sim_options)

```

* Activating parallel execution and execution time display
In that case, parallel execution is done over cores number minus 1.

```{r}
# Used cores number
detectCores() - 1

sim_options <- stics_wrapper_options(stics_path = stics_path, data_dir = output_path,
                                     parallel =TRUE, time_display = TRUE)

results <- stics_wrapper(model_options = sim_options)

```
* Specifying cores number to use

```{r}
sim_options <- stics_wrapper_options(stics_path = stics_path, data_dir = output_path,
                                     parallel =TRUE, time_display = TRUE, cores = 2)

results <- stics_wrapper(model_options = sim_options)

```


